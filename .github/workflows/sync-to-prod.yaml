name: Sync Master Branch to S3

permissions:
  contents: write

on:
  push:
    branches:
    - master

jobs:
  sync-files:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Run Sync
      run: |
        aws cloudformation package --template-file cloudformation/BillingMetrics-Template.yaml --s3-bucket ${S3_BUCKET} \
          --s3-prefix aws-account-automation-lambda-transform --output-template-file cloudformation/BillingMetrics-Template-Transformed.yaml  \
          --metadata build_ver=$(git rev-parse --short "$GITHUB_SHA")

        aws s3 sync --delete cloudformation/ s3://${S3_BUCKET}/aws-account-automation/ --content-type text/plain

        pip install boto3
        .github/workflows/index_files.py > Links.md

        git config user.name github-actions
        git config user.email github-actions@github.com
        git add Links.md
        git commit -m "AutoGenerated Links File"
        git push

      env:
        S3_BUCKET: pht-cloudformation
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: 'us-east-1'

#EOF